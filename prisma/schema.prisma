// FootyTracker Database Schema
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// NextAuth.js Authentication Models
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]

  // FootyTracker relations
  events           Event[]
  userAchievements UserAchievement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// Core FootyTracker Models
// ============================================

enum EventType {
  SOCCER
  BASKETBALL
  BASEBALL
  TENNIS
  CONCERT
}

enum VenueType {
  STADIUM
  ARENA
  THEATER
  OTHER
}

enum MediaType {
  PHOTO
  VIDEO
  TICKET
}

enum AchievementTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

model Event {
  id         String    @id @default(cuid())
  type       EventType
  date       DateTime
  venueId    String
  venue      Venue     @relation(fields: [venueId], references: [id])
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  notes      String?   @db.Text
  rating     Int?      @db.SmallInt // 1-5
  companions String[]

  // Sport-specific relations (one of these will be populated)
  soccerMatch    SoccerMatch?
  basketballGame BasketballGame?
  baseballGame   BaseballGame?
  tennisMatch    TennisMatch?
  concert        Concert?

  // Media attachments
  media Media[]

  // Achievement triggers
  triggeredAchievements UserAchievement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([venueId])
  @@index([type])
  @@index([date])
}

model Venue {
  id        String    @id @default(cuid())
  name      String
  city      String
  country   String
  latitude  Float?
  longitude Float?
  type      VenueType @default(STADIUM)

  events Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, city, country])
  @@index([city])
  @@index([country])
}

model Player {
  id          String @id @default(cuid())
  name        String
  sport       String // SOCCER, BASKETBALL, BASEBALL, TENNIS
  team        String?
  externalId  String? // External API ID
  photoUrl    String?
  nationality String?

  // Appearances
  soccerAppearances     SoccerAppearance[]
  basketballAppearances BasketballAppearance[]
  baseballAppearances   BaseballAppearance[]
  tennisAppearances     TennisAppearance[]

  // Tennis matches as player1 or player2
  tennisMatchesAsPlayer1 TennisMatch[] @relation("TennisPlayer1")
  tennisMatchesAsPlayer2 TennisMatch[] @relation("TennisPlayer2")
  tennisMatchesWon       TennisMatch[] @relation("TennisWinner")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, sport])
  @@index([sport])
  @@index([team])
}

model Artist {
  id         String @id @default(cuid())
  name       String @unique
  genre      String?
  externalId String? // MusicBrainz ID (MBID)
  photoUrl   String?

  concerts Concert[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Team {
  id         String @id @default(cuid())
  name       String
  shortName  String?
  tla        String? // Three-letter abbreviation
  sport      String  // SOCCER, BASKETBALL, BASEBALL
  league     String?
  country    String?
  externalId String? // External API ID (Football-Data, NBA, MLB)
  logoUrl    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, sport])
  @@index([sport])
  @@index([league])
}

// ============================================
// Sport-Specific Models
// ============================================

model SoccerMatch {
  id              String   @id @default(cuid())
  eventId         String   @unique
  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  homeTeam        String
  awayTeam        String
  homeScore       Int      @default(0)
  awayScore       Int      @default(0)
  competition     String?
  externalMatchId String?

  appearances SoccerAppearance[]

  @@index([homeTeam])
  @@index([awayTeam])
  @@index([competition])
}

model SoccerAppearance {
  id            String      @id @default(cuid())
  matchId       String
  match         SoccerMatch @relation(fields: [matchId], references: [id], onDelete: Cascade)
  playerId      String
  player        Player      @relation(fields: [playerId], references: [id])
  goals         Int         @default(0)
  assists       Int         @default(0)
  cleanSheet    Boolean     @default(false)
  yellowCard    Boolean     @default(false)
  redCard       Boolean     @default(false)
  minutesPlayed Int?

  @@index([matchId])
  @@index([playerId])
}

model BasketballGame {
  id             String   @id @default(cuid())
  eventId        String   @unique
  event          Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  homeTeam       String
  awayTeam       String
  homeScore      Int      @default(0)
  awayScore      Int      @default(0)
  competition    String?
  externalGameId String?

  appearances BasketballAppearance[]

  @@index([homeTeam])
  @@index([awayTeam])
}

model BasketballAppearance {
  id        String         @id @default(cuid())
  gameId    String
  game      BasketballGame @relation(fields: [gameId], references: [id], onDelete: Cascade)
  playerId  String
  player    Player         @relation(fields: [playerId], references: [id])
  points    Int            @default(0)
  rebounds  Int            @default(0)
  assists   Int            @default(0)
  steals    Int            @default(0)
  blocks    Int            @default(0)
  turnovers Int            @default(0)
  minutes   String?

  @@index([gameId])
  @@index([playerId])
}

model BaseballGame {
  id             String   @id @default(cuid())
  eventId        String   @unique
  event          Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  homeTeam       String
  awayTeam       String
  homeScore      Int      @default(0)
  awayScore      Int      @default(0)
  competition    String?
  externalGameId String?

  appearances BaseballAppearance[]

  @@index([homeTeam])
  @@index([awayTeam])
}

model BaseballAppearance {
  id         String       @id @default(cuid())
  gameId     String
  game       BaseballGame @relation(fields: [gameId], references: [id], onDelete: Cascade)
  playerId   String
  player     Player       @relation(fields: [playerId], references: [id])
  position   String?
  homeRuns   Int          @default(0)
  hits       Int          @default(0)
  rbis       Int          @default(0)
  runs       Int          @default(0)
  atBats     Int          @default(0)
  strikeOuts Int          @default(0)
  walks      Int          @default(0)

  @@index([gameId])
  @@index([playerId])
}

model TennisMatch {
  id         String   @id @default(cuid())
  eventId    String   @unique
  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  player1Id  String
  player1    Player   @relation("TennisPlayer1", fields: [player1Id], references: [id])
  player2Id  String
  player2    Player   @relation("TennisPlayer2", fields: [player2Id], references: [id])
  winnerId   String?
  winner     Player?  @relation("TennisWinner", fields: [winnerId], references: [id])
  score      String // e.g., "6-4, 3-6, 7-5"
  tournament String?
  round      String?

  appearances TennisAppearance[]

  @@index([player1Id])
  @@index([player2Id])
  @@index([tournament])
}

model TennisAppearance {
  id       String      @id @default(cuid())
  matchId  String
  match    TennisMatch @relation(fields: [matchId], references: [id], onDelete: Cascade)
  playerId String
  player   Player      @relation(fields: [playerId], references: [id])
  won      Boolean     @default(false)
  setsWon  Int         @default(0)

  @@index([matchId])
  @@index([playerId])
}

model Concert {
  id               String   @id @default(cuid())
  eventId          String   @unique
  event            Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  artistId         String
  artist           Artist   @relation(fields: [artistId], references: [id])
  tourName         String?
  openingActs      String[]
  externalSetlistId String?

  setlist SetlistItem[]

  @@index([artistId])
  @@index([tourName])
}

model SetlistItem {
  id        String  @id @default(cuid())
  concertId String
  concert   Concert @relation(fields: [concertId], references: [id], onDelete: Cascade)
  songName  String
  order     Int
  isEncore  Boolean @default(false)
  notes     String?

  @@index([concertId])
  @@index([order])
}

// ============================================
// Media Storage
// ============================================

model Media {
  id           String    @id @default(cuid())
  eventId      String
  event        Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  type         MediaType
  url          String
  thumbnailUrl String?
  caption      String?

  createdAt DateTime @default(now())

  @@index([eventId])
}

// ============================================
// Achievements System
// ============================================

model Achievement {
  id          String          @id @default(cuid())
  name        String          @unique
  description String
  icon        String
  criteria    Json            // Flexible criteria definition
  tier        AchievementTier

  userAchievements UserAchievement[]

  createdAt DateTime @default(now())
}

model UserAchievement {
  id             String      @id @default(cuid())
  userId         String
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId  String
  achievement    Achievement @relation(fields: [achievementId], references: [id])
  triggerEventId String?
  triggerEvent   Event?      @relation(fields: [triggerEventId], references: [id])
  unlockedAt     DateTime    @default(now())

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
}


